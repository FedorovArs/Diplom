<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>


<!DOCTYPE html>
<html lang="ru">
<html>
<head>
    <meta charset="UTF-8">
    <title>Чат</title>
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-32x32.png">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
          integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css"
          integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.css">
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.js">
    </script>
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/authorize.css">
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
</head>
<body>

<div id="app" v-bind:style="{ 'background-image': 'url(' + backgroundImage + ')' }">
    <div v-if="isAuthorize" class="container h-80 authorizeWindow">
        <div class="row align-items-center h-100">
            <div class="col-3 mx-auto">
                <div class="text-center">
                    <img id="profile-img" class="rounded-circle profile-img-card"
                         src="https://i.imgur.com/6b6psnA.png"/>
                    <p id="profile-name" class="profile-name-card"></p>
                    <form class="form-signin">
                        <input v-model:value="userName" type="text" class="form-control form-group"
                               placeholder="nickname" required autofocus/>
                        <button @click="authorized" type="button" class="btn btn-lg btn-primary btn-block btn-signin">
                            enter
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div v-else class="container-fluid h-100">
        <div class="row justify-content-center h-100">
            <div class="col-md-4 col-xl-3 chat">
                <div class="card mb-sm-3 mb-md-0 contacts_card">
                    <div class="card-header">
                        <div class="input-group">
                            <input type="text" placeholder="Search..." name="" class="form-control search">
                            <div class="input-group-prepend">
                                <span class="input-group-text search_btn"><i class="fas fa-search"></i></span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body contacts_body">
                        <ul class="contacts">
                            <li v-for="user in users" :key="user.id" @click="selectUser(user)"
                                :class="{ active: user.isActive }">
                                <div class="d-flex bd-highlight">
                                    <div class="img_cont">
                                        <img :src=user.avatar class="rounded-circle user_img">
                                        <span class="online_icon"></span>
                                    </div>
                                    <div class="user_info">
                                        <span>{{ user.name }}</span>
                                        <p>{{ user.name }} is online</p>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-8 col-xl-6 chat">
                <div class="card">
                    <div class="card-header msg_head">
                        <div class="d-flex bd-highlight">
                            <div class="img_cont">
                                <img :src=activeAvatar
                                     class="rounded-circle user_img">
                                <span class="online_icon"></span>
                            </div>
                            <div class="user_info">
                                <span>Chat with {{ activeUser }}</span>
                                <p>{{activeMessages.length}} Messages</p>
                            </div>
                            <div class="video_cam">
                                <span><i class="fas fa-video"></i></span>
                                <span><i class="fas fa-phone"></i></span>
                            </div>
                        </div>
                        <span id="action_menu_btn" @click="dropdownMenu"><i class="fas fa-ellipsis-v"></i></span>
                        <div class="action_menu">
                            <ul>
                                <li><i class="fas fa-user-circle"></i> View profile</li>
                                <li><i class="fas fa-users"></i> Add to close friends</li>
                                <li><i class="fas fa-plus"></i> Add to group</li>
                                <li><i class="fas fa-ban"></i> Block</li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body msg_card_body">
                        <div v-for="message in activeMessages">
                            <div class="d-flex mb-4"
                                 :class="[ message.name === userName ? 'justify-content-start' : 'justify-content-end']">
                                <div class="img_cont_msg">
                                    <img :src=message.avatar class="rounded-circle user_img_msg">
                                </div>
                                <div :class="[message.name === userName ? 'msg_cotainer' : 'msg_cotainer_send']">
                                    User {{message.name}} say: {{ message.message }}
                                    <span :class="[message.name === userName ? 'msg_time' : 'msg_time_send']">{{ message.time }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="input-group">
                            <div class="input-group-append">
                                <span class="input-group-text attach_btn"><i class="fas fa-paperclip"></i></span>
                            </div>
                            <textarea @keydown.ctrl.enter.prevent.exact="sendMessage" v-model:value="message" name=""
                                      class="form-control type_msg"
                                      placeholder="Type your message..."></textarea>
                            <div class="input-group-append">
                                <span v-on:click="sendMessage" class="input-group-text send_btn"><i
                                        class="fas fa-location-arrow"></i></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="socket.io/socket.io.js"></script>

<script>
    let socket = null;
    let publicGroupId = "00000000000000000000";
    let publicGroupType = 0;
    let userType = 1;
    let FIRST = 0;
    var app = new Vue({
            el: '#app',
            data: {
                activeUser: 'public',
                activeMessages: [],
                activeAvatar: '',

                users: [],
                backgroundImage: "'https://i.imgur.com/xhiRfL6.jpg'",
                isAuthorize: true,
                userName: null,
                userAvatar: "https://banner2.cleanpng.com/20190128/ulo/kisspng-security-hacker-white-hat-anonymous-logo-products-and-services-data-solver-5c4f1b3b23ab83.7011001115486881871461.jpg",
                message: null,
                messages: []

            },
            methods: {
                dropdownMenu() {
                    $('.action_menu').toggle();
                },
                selectUser(user) {
                    for (let i = 0; i < app.users.length; i++) {
                        app.users[i][`isActive`] = false;
                    }
                    user[`isActive`] = true;
                    app.activeUser = user.name;
                    app.activeAvatar = user.avatar;

                    let filteredMessages = app.messages.filter(function (element) {
                        return element.id === user.id;
                    });
                    app.activeMessages = filteredMessages[FIRST].messages;
                },
                authorized: function () {
                    if (!this.userName) {
                        alert("Set nickname")
                    } else {
                        this.sendGreeting();
                        this.getUsers();
                        this.isAuthorize = false;
                        this.backgroundImage = '';
                    }
                },

                sendMessage() {
                    if (this.message) {
                        if (this.activeUser !== "public") {
                            let newMessage = {
                                type: userType,
                                message: this.message,
                                avatar: this.userAvatar,
                                name: this.userName,
                                time: (new Date).toLocaleTimeString(),
                            };

                            app.activeMessages.push(newMessage);
                        }

                        socket.emit('sendMessage', this.message, this.activeUser);
                        this.message = '';
                    }
                },
                sendGreeting: function () {
                    socket.emit('greeting', this.userName);
                },
                getUsers: function () {
                    socket.emit('getUsers');
                }
            },
            mounted() {
                socket.on('addMessage', function (message) {
                    if (message.type === publicGroupType) {
                        let publicUser = app.messages.filter(element => element.id === publicGroupId)[FIRST];
                        publicUser.messages.push(message);
                    } else if (message.type === userType) {
                        let recipientMessages = app.messages.filter(element => element.id === message.recipient);
                        if (recipientMessages) {
                            recipientMessages[FIRST].messages.push(message);
                        }
                    }
                });
                socket.on('nameIsBusy', function (message) {
                    alert(message);
                    location.reload();
                });
                socket.on('userDisconnect', function (disconnectUser) {
                    app.messages.filter(element => element.id === publicGroupId)[FIRST]
                        .messages.push({
                        type: publicGroupType, message: `User ${disconnectUser.name} disconnected.`,
                        avatar: "https://banner2.cleanpng.com/20180823/wk/kisspng-computer-icons-service-user-travel-ims-an-amadeus-setting-svg-png-icon-free-download-1999-2-onl-5b7f0a40a5df71.0483892015350523526794.jpg",
                        name: "System", time: (new Date).toLocaleTimeString()
                    });

                    for (let i = 0; i < app.users.length; i++) {
                        let user = app.users[i];
                        if (user.id === disconnectUser.id) {
                            app.users.splice(i, 1);
                            break;
                        }
                    }
                });
                socket.on('onlineUserList', function (usersJson) {
                    let users = JSON.parse(usersJson);
                    app.users.clear;

                    users.forEach(function (user) {
                        if (user.name !== app.userName) {
                            app.users.push(user);
                            app.messages.push({id: user.id, messages: []});
                        }
                    });

                    let filteredMessages = app.messages.filter(function (element) {
                        return element.id === publicGroupId;
                    });
                    app.activeMessages = filteredMessages[FIRST].messages;
                    app.activeAvatar = app.users.filter(element => element.type === publicGroupType)[0].avatar;
                });
                socket.on('userJoined', function (user) {
                    app.messages.filter(element => element.id === publicGroupId)[FIRST]
                        .messages.push({
                        type: publicGroupType, message: `User ${user.name} connected.`,
                        avatar: "https://banner2.cleanpng.com/20180823/wk/kisspng-computer-icons-service-user-travel-ims-an-amadeus-setting-svg-png-icon-free-download-1999-2-onl-5b7f0a40a5df71.0483892015350523526794.jpg",
                        name: "System", time: (new Date).toLocaleTimeString()
                    });

                    let isAlreadyExist = app.users.some(function (element) {
                        return element.id === user.id;
                    });
                    if (!isAlreadyExist) {
                        app.users.push(user);
                        app.messages.push({id: user.id, messages: []});
                    }
                })
            },
            created() {
                socket = io({transports: ['websocket'], upgrade: false});
            }
        })
    ;
</script>
</body>
</html>